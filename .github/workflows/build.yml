name: Build RE-SS-01

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      REPO_URL: https://github.com/libwrt/openwrt.git
      REPO_BRANCH: openwrt-23.05
      TZ: Asia/Shanghai
      TAG_PREFIX: jdcloud-re-ss-01

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Build Environment
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          build-essential ccache libncurses-dev zlib1g-dev gawk git gettext unzip file \
          python3 python3-distutils python3-setuptools python3-pip pkg-config

    - name: Prepare Feeds
      run: |
        ./diy-part1.sh
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build Firmware
      run: |
        cp .config .config.backup
        make defconfig
        ./diy-part2.sh
        make -j$(nproc) V=s

    - name: Collect Firmware
      run: |
        mkdir -p firmware
        find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.gz" -exec cp {} firmware/ \;

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_PREFIX }}-${{ github.run_number }}
        name: RE-SS-01 Build ${{ github.run_number }}
        files: firmware/*
        overwrite_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup old releases
      uses: devops-infra/action-cleanup-release@v2
      with:
        keep_latest: 3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}