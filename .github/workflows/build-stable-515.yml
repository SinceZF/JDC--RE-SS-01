name: Build JDCloud RE-SS-01

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 0"

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git gcc g++ clang flex bison \
         gettext libssl-dev python3 python3-distutils zlib1g-dev \
         libncurses-dev rsync unzip wget file

    - name: Clone Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Copy Custom Config
      run: |
        cp $GITHUB_WORKSPACE/.config openwrt/.config

    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Defconfig + Validate
      run: |
        cd openwrt
        make defconfig

        echo "Checking target device in .config"
        grep -E "jdcloud_re-ss-01" .config || true

    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Build
      run: |
        cd openwrt
        make -j$(nproc)

    - name: Collect Firmware
      run: |
        mkdir firmware
        find openwrt/bin/targets -name "*factory*.bin" -exec cp {} firmware/ \;
        find openwrt/bin/targets -name "*sysupgrade*.bin" -exec cp {} firmware/ \;

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JDCloud-RE-SS-01
        path: firmware

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "jdcloud-re-ss-01-$(date +%Y%m%d)"
        name: "JDCloud RE-SS-01 Build $(date +%Y%m%d)"
        files: firmware/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}