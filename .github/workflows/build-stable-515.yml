name: JDCloud RE-SS-01 Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev \
        libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
        file wget

    - name: Clone Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt

    - name: Load Custom Config
      run: |
        cd openwrt
        cp $GITHUB_WORKSPACE/.config .config

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate Config
      run: |
        cd openwrt
        make defconfig

        if grep -q "CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_jdcloud_re-ss-01=y" .config; then
            echo "SUCCESS: Hardware locked"
        else
            echo "ERROR: TARGET MODEL FAILED"
            grep jdcloud .config || true
            exit 1
        fi

    - name: Download Packages
      run: |
        cd openwrt
        make download -j8

    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc)

    - name: Organize Firmware
      run: |
        mkdir firmware
        find openwrt/bin/targets/ -name "*factory*.bin" -exec cp {} firmware/ \;
        find openwrt/bin/targets/ -name "*sysupgrade*.bin" -exec cp {} firmware/ \;

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JDCloud-RE-SS-01-Firmware
        path: firmware

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: success()
      with:
        tag_name: JDCloud-$(date +%Y%m%d)
        name: JDCloud RE-SS-01 Build $(date +%Y%m%d)
        files: firmware/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}