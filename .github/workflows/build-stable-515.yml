name: Build ImmortalWrt Stable 5.15 JDCloud

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Initialization environment
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"

    - name: Clone source code
      run: |
        # 使用稳定的 23.05 分支，默认内核通常为 5.15
        git clone $REPO_URL -b $REPO_BRANCH openwrt

    - name: Update & Install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Ultra Stable Configuration (NSS + 5.15)
      run: |
        cd openwrt
        
        # 1. 基础硬件定义
        cat > .config <<EOF
        CONFIG_TARGET_ipq60xx=y
        CONFIG_TARGET_ipq60xx_generic=y
        CONFIG_TARGET_ipq60xx_generic_DEVICE_jdcloud_re-ss-01=y
        
        # 强制指定内核版本为 5.15 (如果源码默认不是 5.15 则生效)
        CONFIG_LINUX_5_15=y
        
        # 极致稳定 NSS 驱动配置
        CONFIG_PACKAGE_kmod-qca-nss-drv=y
        CONFIG_PACKAGE_kmod-qca-nss-ecm=y
        CONFIG_PACKAGE_kmod-qca-nss-ecm-standard=y
        CONFIG_PACKAGE_kmod-qca-nss-drv-pppoe=y
        CONFIG_PACKAGE_kmod-qca-nss-drv-ipv6=y
        CONFIG_PACKAGE_kmod-qca-nss-drv-bridge-mgr=y
        
        # 网络优化插件 (极致稳定选型)
        CONFIG_PACKAGE_luci-app-turboacc=y
        CONFIG_TURBOACC_INCLUDE_OFFLOADING=y
        CONFIG_TURBOACC_INCLUDE_BBR_CCA=y
        CONFIG_PACKAGE_luci-app-smartdns=y
        CONFIG_PACKAGE_luci-app-sqm=y
        CONFIG_PACKAGE_kmod-sched-cake=y
        CONFIG_PACKAGE_ipv6helper=y
        
        # 自动分流 (使用稳定版 PBR)
        CONFIG_PACKAGE_luci-app-pbr=y
        
        # 禁用不稳定的实验性功能
        # CONFIG_PACKAGE_luci-app-flowoffload is not set
        EOF
        
        # 2. 移除干扰，防止内核崩溃
        sed -i 's/CONFIG_KERNEL_KALLSYMS=y/CONFIG_KERNEL_KALLSYMS=n/' .config
        
        # 3. 性能补丁：NSS 优先级优化
        echo "net.netfilter.nf_conntrack_checksum=0" >> package/base-files/files/etc/sysctl.conf
        
        make defconfig

    - name: Download & Compile
      run: |
        cd openwrt
        make download -j8
        make -j$(nproc) || make -j1 V=s

    - name: Organize files
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: env.FIRMWARE != ''
      with:
        tag_name: AX1800Pro_5.15_Stable_${{ github.run_id }}
        files: ${{ env.FIRMWARE }}/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
