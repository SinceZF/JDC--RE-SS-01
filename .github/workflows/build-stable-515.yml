name: JDCloud RE-SS-01 Build

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 0"

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization Environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev \
        libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
        file wget curl

    - name: Clone Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Load Custom Config
      run: |
        cp $GITHUB_WORKSPACE/.config openwrt/.config

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate Config
      run: |
        cd openwrt
        make defconfig
        echo "Detected target:"
        grep jdcloud .config || true

    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc)

    - name: Collect Firmware
      run: |
        mkdir firmware
        find openwrt/bin/targets/ -name "*factory*.bin" -exec cp {} firmware/ \;
        find openwrt/bin/targets/ -name "*sysupgrade*.bin" -exec cp {} firmware/ \;

    - name: Set Release Tag
      run: echo "TAG=jdcloud-re-ss-01-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JDCloud-RE-SS-01-Firmware
        path: firmware

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: success()
      with:
        tag_name: ${{ env.TAG }}
        name: JDCloud RE-SS-01 Build ${{ env.TAG }}
        files: firmware/*
        overwrite_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}