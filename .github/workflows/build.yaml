name: JDCloud RE-SS-01 CI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 0"

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev \
        libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
        file wget curl

    - name: Clone Source
      run: git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Copy Custom Config
      run: cp $GITHUB_WORKSPACE/.config openwrt/.config

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Defconfig + Check Target
      run: |
        cd openwrt
        make defconfig
        grep jdcloud .config || true

    - name: Download Source Packages
      run: cd openwrt && make download -j$(nproc)

    - name: Compile OpenWrt
      run: cd openwrt && make -j$(nproc)

    - name: Collect Firmware
      run: |
        mkdir -p firmware
        find openwrt/bin/targets/ -type f \( -name "*factory.bin" -o -name "*squashfs-factory.bin" -o -name "*sysupgrade.bin" -o -name "*squashfs-sysupgrade.bin" \) -exec cp {} firmware/ \;

    - name: Set Release Tag
      run: echo "TAG=jdcloud-re-ss-01-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JDCloud-RE-SS-01-Firmware
        path: firmware

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: success()
      with:
        tag_name: ${{ env.TAG }}
        name: JDCloud RE-SS-01 Build ${{ env.TAG }}
        files: firmware/*
        overwrite_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup Old Releases (Keep Latest 3)
      if: success()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const releases = await github.rest.repos.listReleases({owner, repo, per_page: 100});
          const allReleases = releases.data.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
          const keep = 3;
          if(allReleases.length>keep){
            const toDelete=allReleases.slice(keep);
            for(const rel of toDelete){
              await github.rest.repos.deleteRelease({owner, repo, release_id: rel.id});
              try{ await github.rest.git.deleteRef({owner, repo, ref:`tags/${rel.tag_name}`}); }catch(e){}
            }
          }